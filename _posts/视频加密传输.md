视频加密传输
==

## 为什么要加密视频

付费观看视频的模式是很多平台的核心业务，如果视频被录制并非法传播，付费业务将受到严重威胁，因此需要对视频服务进行加密。“边播放边解密”，这是加密解密的最优方案。

## 常见视频加密技术

视频加密技术分为两种：

1.  防盗链：通过验证的用户才能访问到没有加密的视频内容，这种方案存在视频很容易就被下载的风险，严格来说这不属于加密。这种方式其实是资源访问授权，它实现起来简单。
2.  加密视频本身：通过对称加密算法加密视频内容本身，用户获得加密后的视频内容，通过验证的用户可以获取解密视频的密钥，在客户端解密后播放。这种方式实现起来流程复杂会带来更多的计算量。

一般结合这两种技术一起用。

## 流媒体加密技术原理

看视频分为两种，看点播和看录播。
要看点播可以通过下载完整个视频后再看，或者通过流媒体边下边看。
看直播只能通过流媒体看最新的画面。

加密整个视频的技术很简单，把视频看成一个文件采用加密文件的技术。
加密流媒体的技术很少，也很难找到学习资料，一下是参考大神们相关技术文档总结的流媒体加密技术。

常见的应用与浏览器播放的流媒体传输协议有：

*   HLS：Apple 推出的基于 HTTP 协议的 MP4 分片传输协议，可用于点播和直播场景。每下载一个分片都需要发生一次 HTTP 请求，所以严格来说 HLS 不能称为流媒体传输协议。
*   HTTP-FLV：基于 HTTP 长连接的 FLV 分块 tag 传输协议，可用于点播和直播场景。
*   RTMP：基于 TCP 的 FLV 分块 message 传输协议，用于 Flash 客户端。

### 流媒体加密原理

可以看出一个规律这些流媒体传输协议都必须把视频流拆分成连续的小块之后再被传送，只不过分块的大小和视频容器的格式不一样而已。

**流媒体加密技术的核心就在于对这每一小块视频分别使用对称加密算法，在服务端加密客户端解密，通过权限验证的用户才能拿到解密一小块视频的密钥。**

### 为什么不用 HTTPS 加密

可能有人会问为什么不用 HTTPS 加密？原因是 HTTPS 在网络传输层进行非对称加密，目的是为了防止中间人窃听劫持，任何人都可以和我们的服务器建立 HTTPS 链接获取到原数据。而视频加密的目的不是为了防止有中间人窃听我们的视频数据，而是要让视频数据本身被加密。

### 为什么选择对称加密

现代成熟的加密技术分为对称加密算法和公钥密码算法(非对称加密)。之所以选择对称加密是因为流媒体要求很强的实时性，数据量又很大。公钥密码算法的计算都比较复杂，效率较低，适合对少量数据进行加密。对称加密效率相对较高，所以流媒体加密首选对称加密。例如在 SSH 登入的时候会先通过公钥密码算法传输一个密钥，再用这个密钥用作对称加密算法的密钥，在数据传输过程中使用对称加密算法来提示数据传输效率。

## 几种适用加密方式介绍

### HLS 加密

苹果公司的HLS（Http Live Stream）协议，他这个协议是苹果的动态码率自适应技术,主要用于PC和Apple终端的音视频服务。HLS 是目前最成熟的支持流媒体加密的能应用在浏览器里的流媒体传输协议，HLS 原生支持加密。其包括一个m3u8的索引文件,TS(Transport Stream)媒体分片文件和key加密串文件。

在介绍如何加密 HLS 先了解下 HLS 相比于其它流媒体传输协议的优缺点。
优点在于：

*   建立在 HTTP 之上，使用简单，接入代价小。
*   分片技术有利于 CDN 加速技术的实施。
*   部分浏览器原生支持，支持点播和录播。

缺点在于：

*   用作直播时延迟太大。
*   移动端支持还好，PC端只有 Safari 原生支持。

#### HLS 加密原理

HLS 由两部分构成，一个是 .m3u8 文件，一个是 .ts 视频文件（TS 是视频文件格式的一种）。整个过程是，浏览器会首先去请求 .m3u8 的索引文件，然后解析 m3u8，找出对应的 .ts 文件链接，并开始下载。
[![hls](http://ou21vt4uz.bkt.clouddn.com/interview/video_%20encryption/HLS1.png)

m3u8 文件是一个文本文件，在开启 HLS 加密时，内容大致如下：

```
#EXTM3U
#EXT-X-VERSION:6
#EXT-X-TARGETDURATION:10
#EXT-X-MEDIA-SEQUENCE:26
#EXT-X-KEY:METHOD=AES-128,URI="https://priv.example.com/key.do?k=1"
#EXTINF:9.901,
http://media.example.com/segment26.ts
#EXT-X-KEY:METHOD=AES-128,URI="https://priv.example.com/key.do?k=2"
#EXTINF:9.501,
http://media.example.com/segment28.ts

```

这个文件描述了每个 TS 分片的 URL ，但这些分片都是加密后的内容，要还原出原内容需要从

```
#EXT-X-KEY:METHOD=AES-128,URI="https://priv.example.com/key.do?k=1"

```

中解析出获取解密密钥的URL `https://priv.example.com/key.do` 和对称加密算法 `AES-128` 。
获取到密钥后再在客户端解密出原内容。
可以看出启用 HLS 加密后会多出更多的事情：

*   针对每个 TS 需要去请求获取密钥。
*   需要多提供一个给客户端获取密钥的鉴权服务。
*   针对每个 TS 需要去执行对称加密的解密计算。

这会带来更多的网络请求和计算量，可能会对延迟和性能造成一定的不良影响。

#### HLS 加密实战

HLS的关键其实是生成m3u8索引文件和TS媒体文件.

##### m3u8索引文件和TS媒体文件

![](http://ou21vt4uz.bkt.clouddn.com/interview/video_%20encryption/HLS2.png) 
![](http://ou21vt4uz.bkt.clouddn.com/interview/video_%20encryption/HSL3.png)
这是一个完整的并且加密过的TS文件和m3u8索引文件，这个key是秘钥，可以看到m3u8索引文件里的内容都是按照HLS规范来编写的。

##### HLS加密流程

###### **两端播放器适配**

* IOS
ios系统天然支持m3u8，系统播放器都可以播放m3u8视频。

* Android
android3.0之后支持HLS协议，因此也可以播放m3u8视频，目前android端vitamio，VLC等可以播放m3u8。

###### **客户端工作**

客户端下载到本地传给端播放器一个m3u8索引文件，先使用key解密索引文件后，播放器会根据索引文件里的内容，播放相应的TS文件，如果TS是加密过的文件，则会先使用key解密ts文件并播放。

###### **服务器工作**

服务器需要切片出TS文件并进行AES加密，然后客户端下载到本地丢给播放器播放,因为这种方式是基于HLS协议，m3u8格式固定，播放器可以自行解密。

###### **防止第三方播放器播放**

将m3u8索引文件再次加密下，索引文件也就几十kb，加密后，客户端解密后丢给播放器播放，这样第三方的播放器就播放不了了。

[HLS,m3u8,TS相关资料](http://blog.csdn.net/wdxin1322/article/details/53910034)

##### 破解 HLS 加密

有加密就有破解，在明白 HLS 加密原理后，你想过如何去破解它吗？先定义下破解成功是指：获取到视频加密前的完整原文件。我想到的方法是：

1.  先付费买一个可正常观看受保护视频的账号。
2.  用抓包工具抓下所有网络请求(可以筛选下限制到只保存 HLS 和 获取key 的请求，防止保存太多垃圾数据)。
3.  第2步保存下来了加密后的 TS 分片和加密分片所需要的密钥。
4.  写一个脚本以 m3u8 为索引一一解密出加密后的 TS 分片的原文件，再把 TS 拼接成完整的视频原文件。

似乎破解的难度也不会很复杂。

### 异或加密

异或加密其实不算是加密，因为它是对文件进行前后的反转，因为我们知道播放器从开头开始播放的，我们把开头的几十或者几百字节进行异或加密，则播放器就播放不了了，而两次异或加密就是解密，这种方法比较简单，适合比较简单的加密，而且容易破解，**因此不建议使用**，当然大家可以适当的了解下.

[异或加密的介绍](https://www.cnblogs.com/albertblues/p/5670528.html)

这种方式的加密对于大文件来说也是不耗时的，非常快，我们可以使用RandomAccessFile这个类来随机读取文件的内容进行异或,播放器是从头开始播放的，我们就从头开始，异或几十个字节即可完成加密,解密操作就是再进行一次异或即可.

### 前，中，后，对文件加密2M的长度

最后确定使用的方案是对文件进行前中后进行三段加密，加密总长度为2M的大小（即前面读取512kb,中间读取1M，文件末尾读取512kb）.

这三段加密都涉及到文件的读取，尤其对于大文件的读取，我们使用java的RandomAccessFile（随机访问文件）

这个类来进行文件的加密和解密.

RandomAccessFile有两种模式 一种是“读写”模式（rw）,另一种是“只读”模式（r）,它没有“只写”模式，ios使用的fopen有只写模式.

 RandomAccessFile sourceRaf = new RandomAccessFile(sourceFile, "r");
  RandomAccessFile tempRaf = new RandomAccessFile(tempFile, "rw");

我们使用这个类对文件进行加密和解密的操作.

针对这块基本是文件的读取，我就不做过多的描述，源码如下，CSDN没有分了，过段时间免费开源，见谅!

源码地址:

[文件前中后三段加密](http://download.csdn.net/download/shenshibaoma/10195694)

## 三种加密方式的对比

* **HLS加密**

要在手机端先走通这个流程，即自己完成TS切片，加密TS，自己编写m3u8索引文件，然后手机端使用vitamio播放器进行播放，这个过程，ios自身系统播放器不支持本地播放m3u8的视频文件，android端使用vitamio传入本地路径可以播放m3u8视频，ios换成vitamio后也可以进行播放;第二个是要播放加密的m3u8文件，首先要对TS进行AES加密，生成key文件，手动编写m3u8文件，然后传入播放器测试,分片加密耗时两周测试完成，说明这个方式是可行的，也是最好的加密方式。

* **异或加密**

异或加密非常的快，对于大文件，但是基于他非常的简单，容易破解，摒弃。

* **文件的前中后加密**

文件的前中后加密，这种方式是比较不错的，PC端用于对小文件的加密操作比较多，在使用RandomAccessFile进行追加内容时，需要手动将指针移动到当前文件长度的位置，即raf.seek(xxx),再进行raf.write()追加操作.

## 总结

目前流媒体加密技术还不成熟，除了 HLS 协议提供了方便成熟的方案外，其它协议的加密技术还不成熟。

RTMP 协议提供了一个变种版 RTMPE 可以加密流媒体，原理和 HLS 加密类似，一般找不到合适的服务端去支持 RTMPE 协议。
